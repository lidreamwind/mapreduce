# 需求分析

![image-20210324204131214](.\图片\日志需求.png)

- 定时采集已经滚动完毕的日志文件
- 将待采集文件上传到临时目录
- 备份日志文件

# 代码实现

## 日志调度功能实现

pom文件中的脚步和之前的代码pom是一样的，只需要hadoop-common hadoop-client hadoop-hdfs

```java
<dependencies>
    <!-- 测试类-->
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>RELEASE</version>
    </dependency>
    <!-- 日志操作-->
    <dependency>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j-core</artifactId>
        <version>${log.version}</version>
    </dependency>
    <!-- Hadoop 的HDFS操作 -->
    <dependency>
        <groupId>org.apache.hadoop</groupId>
        <artifactId>hadoop-common</artifactId>
        <version>${hadoop.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.hadoop</groupId>
        <artifactId>hadoop-client</artifactId>
        <version>${hadoop.version}</version>
    </dependency>
    <dependency>
        <groupId>org.apache.hadoop</groupId>
        <artifactId>hadoop-hdfs</artifactId>
        <version>${hadoop.version}</version>
    </dependency>

</dependencies>
```

**项目的目录结构如下所示**

![image-20210325102844520](.\图片\日志采集Java目录结构.png)



### 定时采集

scheduler.Scheduler定时任务如下。

```java
package com.lagou.logCollect.scheduler;

import com.lagou.logCollect.hdfs.CollectTask;
import java.util.Timer;

public class Scheduler {
    public static void main(String[] args) {
         // 使用Timer做定时任务
        Timer timer = new Timer();
        // 延迟0没有，，  周期是一小时一次：3600*1000
        timer.schedule(new CollectTask(),0,3600*1000);
    }
}
```

### 上传到临时目录



#### 配置文件

```java
package com.lagou.logCollect.utils;

import java.io.*;
import java.util.Properties;

public class PropertiesUtils {
    private Properties props = null;

    public Properties loadProp(){
        try {
            if(props==null) {
                synchronized ("lock") {
                    if (props == null) {
                        props = new Properties();
                        // 方式一，在conf配置文件中进行配置，打包的时候，，会有更好的友好度
                        String path = new File(".").getAbsolutePath().replace(".","conf")+File.separator+"collect.properties";
                        InputStream in = new BufferedInputStream(new FileInputStream(path));
                        // 方拾二，使用classLoader进行加载
                        InputStream inputStream = PropertiesUtils.class.getClassLoader().getResourceAsStream("collect.properties");
                        props.load(in);
                    }
                }
            }
            return props;
        } catch (IOException e) {
            e.printStackTrace();
            return null;
        }
    }

    public static void main(String[] args) {
        Properties properties = new PropertiesUtils().loadProp();
        System.out.println(properties.getProperty("LOCAL_LOG_DIR"));
    }
}
```

#### 静态变量

```java
package com.lagou.logCollect.common;

public class ConsistantVar {
    public static String LOCAL_LOG_DIR="LOCAL_LOG_DIR";
    public static String LOCAL_LOG_DIR_BAK="LOCAL_LOG_DIR_BAK";
    public static String LOG_PREFIX="LOG_PREFIX";
    public static String HDFS_LOG_DIR="HDFS_LOG_DIR";
    public static String LOG_TEMP_DIR = "LOG_TEMP_DIR";
}
```

#### 定时任务实现

```java
package com.lagou.logCollect.hdfs;

import com.lagou.logCollect.common.ConsistantVar;
import com.lagou.logCollect.utils.PropertiesUtils;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FileStatus;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.Path;

import java.io.File;
import java.io.FileFilter;
import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Properties;
import java.util.TimerTask;

public class CollectTask extends TimerTask {
    @Override
    public void run() {
        //下面是采集的流程
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd");
        String today = simpleDateFormat.format(new Date());
        //获取文件属性
        Properties props = new PropertiesUtils().loadProp();
        //1、扫描指定目录，找到待上传的文件
        File file = new File(props.getProperty(ConsistantVar.LOCAL_LOG_DIR));
            // 查找要上传的文件，是否过滤器形式
        File[] logFiles = file.listFiles(new FileFilter() {
            @Override
            public boolean accept(File pathname) {
                if (pathname.getName().startsWith(props.getProperty(ConsistantVar.LOG_PREFIX))) {
                    return true;
                }
                return false;
            }
        });
        //2、把待上传文件移动到临时目录
            // 判断临时目录是否存在
        File localDirTemp = new File(props.getProperty(ConsistantVar.LOG_TEMP_DIR) );
        if(!localDirTemp.exists()){
            localDirTemp.mkdirs();
        }
        for (File logFile : logFiles) {
            logFile.renameTo(new File(localDirTemp.getAbsolutePath()+File.separator+logFile.getName()));
        }
        // 判断备份目录是否存在
        File localDirBak = new File(props.getProperty(ConsistantVar.LOCAL_LOG_DIR_BAK)+File.separator+today );
        if(!localDirBak.exists()){
            localDirBak.mkdirs();
        }
        //3、将临时目录中的数据，上传到指定目录
        Configuration conf = new Configuration();
        conf.set("fs.defaultFS","hdfs://linux121:9000");
        FileSystem fs = null;
        Path hdfsPath = new Path(props.getProperty(ConsistantVar.HDFS_LOG_DIR)+"/"+today);
        try {
            fs = FileSystem.get(new URI("hdfs://linux121:9000"), conf, "root");
            // 创建目录
            if(!fs.exists(hdfsPath)){
                fs.mkdirs(hdfsPath);
            }
            File[] files = localDirTemp.listFiles();
            for (File file1 : files) {
                //4、上传的文件备份到指定目录
                fs.copyFromLocalFile(new Path(file1.getPath()),new Path(hdfsPath.toString()+"/"+file1.getName()));
                // 文件转移到备份目录
                file1.renameTo(new File(localDirBak.getPath()+File.separator+file1.getName()));
            }

        } catch (IOException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (URISyntaxException e) {
            e.printStackTrace();
        }
    }
}
```


